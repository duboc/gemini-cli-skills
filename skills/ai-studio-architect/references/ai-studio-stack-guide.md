# AI Studio Build Mode Stack Guide

Reference for understanding and migrating the code stack generated by Google AI Studio's Build mode.

## Build Mode Output Stack

AI Studio Build mode generates a modern, standards-based web application. This guide documents every layer and the migration path to GCP production.

### Frontend Stack

| Technology | Version | Role | Production Change |
|-----------|---------|------|-------------------|
| React | 18+ | UI framework (default) | None |
| Angular | 17+ | UI framework (alternative) | None |
| TypeScript | 5+ | Type-safe language | None |
| Vite | 5+ | Build tool and dev server | Configure for Cloud Build |
| Tailwind CSS | 3+ | Utility-first styling | None |
| Framer Motion | 10+ | Animations and transitions | None |

### AI Integration Layer

| Component | AI Studio (Prototype) | Production (GCP) |
|-----------|----------------------|-------------------|
| **SDK** | `@google/generative-ai` | `@google-cloud/vertexai` |
| **Auth** | API key in env variable | Service Account + Workload Identity |
| **Endpoint** | `generativelanguage.googleapis.com` | `${REGION}-aiplatform.googleapis.com` |
| **Location** | Global | Regional (e.g., `us-central1`) |
| **Execution** | Client-side (browser) | Server-side (Cloud Run) |
| **Config** | Hardcoded in `geminiService.ts` | Environment variables from Secret Manager |

## Project Structure Anatomy

```
project-root/
├── public/                    # Static assets (favicon, images)
│   └── index.html             # HTML entry point
├── src/
│   ├── components/            # React/Angular components
│   │   ├── Header.tsx         # App header
│   │   ├── ChatWindow.tsx     # Chat interface (if applicable)
│   │   └── ResultCard.tsx     # Result display components
│   ├── services/
│   │   └── geminiService.ts   # *** CRITICAL: AI orchestration ***
│   ├── types/                 # TypeScript type definitions
│   │   └── index.ts
│   ├── utils/                 # Helper utilities
│   ├── App.tsx                # Main application component
│   ├── index.css              # Tailwind CSS directives
│   └── main.tsx               # Vite entry point
├── package.json               # Dependencies and scripts
├── tsconfig.json              # TypeScript configuration
├── vite.config.ts             # Vite build configuration
├── tailwind.config.js         # Tailwind customization
└── postcss.config.js          # PostCSS plugins
```

## Migration Patterns

### Pattern 1: geminiService.ts Migration

The `geminiService.ts` file is the core AI orchestration module. In AI Studio, it runs client-side. For production, it must move server-side.

**Before (Client-side in AI Studio)**:
```typescript
// src/services/geminiService.ts
import { GoogleGenerativeAI, GenerativeModel } from '@google/generative-ai';

const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;
const genAI = new GoogleGenerativeAI(API_KEY);

export async function generateResponse(prompt: string): Promise<string> {
  const model = genAI.getGenerativeModel({
    model: 'gemini-2.0-flash',
    systemInstruction: 'You are a helpful assistant...',
  });

  const result = await model.generateContent(prompt);
  return result.response.text();
}
```

**After (Server-side on Cloud Run)**:

Create a new backend service:

```typescript
// server/src/routes/generate.ts
import { VertexAI } from '@google-cloud/vertexai';
import { Router } from 'express';

const router = Router();
const vertexAI = new VertexAI({
  project: process.env.PROJECT_ID!,
  location: process.env.REGION || 'us-central1',
});

router.post('/api/generate', async (req, res) => {
  try {
    const { prompt } = req.body;
    const model = vertexAI.getGenerativeModel({
      model: 'gemini-2.0-flash',
      systemInstruction: 'You are a helpful assistant...',
    });

    const result = await model.generateContent(prompt);
    const text = result.response.candidates?.[0]?.content?.parts?.[0]?.text;
    res.json({ text });
  } catch (error) {
    console.error('Generation error:', error);
    res.status(500).json({ error: 'Generation failed' });
  }
});

export default router;
```

Update the frontend to call the backend:

```typescript
// src/services/geminiService.ts (updated)
export async function generateResponse(prompt: string): Promise<string> {
  const response = await fetch('/api/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt }),
  });

  if (!response.ok) throw new Error('Generation failed');
  const data = await response.json();
  return data.text;
}
```

### Pattern 2: Environment Variable Migration

**Before (AI Studio `.env`)**:
```
VITE_GEMINI_API_KEY=AIza...
VITE_PROJECT_ID=my-project
```

**After (Production)**:

Store in Secret Manager:
```bash
echo -n "AIza..." | gcloud secrets create gemini-api-key --data-file=-
```

Access in Cloud Run via environment mapping:
```yaml
# service.yaml
spec:
  template:
    spec:
      containers:
        - env:
            - name: GEMINI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: gemini-api-key
                  key: latest
```

### Pattern 3: Static Assets Migration

**Before**: Served by Vite dev server.

**After**: Two options depending on hosting choice.

**Option A: Cloud Run unified** (frontend + backend in one container):
```dockerfile
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app/dist ./public
COPY --from=builder /app/server ./server
COPY --from=builder /app/node_modules ./node_modules
EXPOSE 8080
CMD ["node", "server/index.js"]
```

**Option B: Cloud Storage + CDN** (SPA hosted separately):
```bash
# Build the frontend
npm run build

# Upload to Cloud Storage
gcloud storage cp -r dist/* gs://$BUCKET_NAME/

# Set index page
gcloud storage buckets update gs://$BUCKET_NAME \
  --web-main-page-suffix=index.html \
  --web-not-found-page=index.html
```

### Pattern 4: AI Chips / Grounding Migration

AI Studio "chips" (e.g., image generation parameters, grounding config) are embedded in `geminiService.ts`.

**Before (AI Studio grounding)**:
```typescript
const model = genAI.getGenerativeModel({
  model: 'gemini-2.0-flash',
  tools: [{ googleSearchRetrieval: { dynamicRetrievalConfig: { mode: 'MODE_DYNAMIC' } } }],
});
```

**After (Vertex AI grounding)**:
```typescript
const model = vertexAI.getGenerativeModel({
  model: 'gemini-2.0-flash',
  tools: [{ googleSearchRetrieval: {} }],
});
```

Enable the required API:
```bash
gcloud services enable discoveryengine.googleapis.com
```

### Pattern 5: Firebase to GCP Native

If the AI Studio project uses Firebase services, map them to GCP equivalents:

| Firebase Service | GCP Equivalent | Migration Notes |
|-----------------|----------------|-----------------|
| Firebase Hosting | Cloud Storage + CDN or Cloud Run | Rewrite rules move to Cloud Run routing |
| Firebase Auth | Identity Platform | Same API, additional enterprise features |
| Firestore (Firebase) | Firestore (GCP) | Same service, different console access |
| Firebase Storage | Cloud Storage | Same underlying service |
| Firebase Functions | Cloud Run or Cloud Functions (2nd gen) | Cloud Run preferred for flexibility |

## Production Checklist

### Security

- [ ] API keys removed from client-side code
- [ ] Service Account created with minimum roles
- [ ] Secrets stored in Secret Manager
- [ ] CORS configured for production domains only (not `*`)
- [ ] Cloud Run requires authentication (unless public-facing)
- [ ] Workload Identity configured (no downloaded key files)

### Performance

- [ ] Vite production build optimized (`npm run build`)
- [ ] Cloud CDN enabled for static assets
- [ ] Cloud Run min instances set for cold start mitigation
- [ ] Firestore indexes created for common queries
- [ ] Images optimized and served from Cloud Storage

### Observability

- [ ] Cloud Logging configured
- [ ] Error reporting enabled
- [ ] Uptime checks created
- [ ] Alerting policies set (error rate, latency)
- [ ] Custom metrics for AI model usage

### CI/CD

- [ ] Cloud Build trigger connected to GitHub
- [ ] Staging environment configured
- [ ] Automated tests in build pipeline
- [ ] Container scanning enabled
- [ ] Rollback strategy documented

## Common Issues

| Issue | Cause | Fix |
|-------|-------|-----|
| "API key not valid" in production | Using AI Studio API key with Vertex AI | Switch to Service Account auth |
| CORS errors | Bucket or Cloud Run missing CORS config | Apply `cors.json` to bucket; add CORS headers to Cloud Run |
| Cold start latency | Cloud Run scaling to zero | Set `--min-instances=1` |
| 403 on Vertex AI | Service Account missing role | Add `roles/aiplatform.user` |
| Build fails on Cloud Build | Missing `npm ci` step | Add install step before build |
| Firestore permission denied | Wrong IAM role | Use `roles/datastore.user`, not `roles/viewer` |
| Images not loading | Bucket not public or CORS blocked | Configure bucket IAM and CORS |
